<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>LinguaLab â€” PWA</title>
  <meta name="theme-color" content="#151c36">
  <link rel="manifest" href="manifest.webmanifest">
  <!-- iOS PWA support -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <style>
    :root { --bg:#0b1021; --panel:#151c36; --accent:#6ee7ff; --accent2:#b4f0ff; --text:#ecf1ff; --muted:#a7b0d6; --good:#35d49b; --warn:#ffd166; --bad:#ff6b6b; }
    html, body { background: var(--bg); color: var(--text); margin: 0; font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; -webkit-text-size-adjust: 100%; }
    header { position: sticky; top: 0; z-index: 5; backdrop-filter: blur(8px); background: linear-gradient(180deg, rgba(11,16,33,0.9), rgba(11,16,33,0.6)); border-bottom: 1px solid rgba(255,255,255,0.08); padding-top: env(safe-area-inset-top); }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 16px; }
    h1 { font-size: 22px; margin: 0; letter-spacing: 0.2px; }
    h1 .spark { color: var(--accent); }
    h2 { font-size: 18px; margin: 16px 0 8px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .panel { background: var(--panel); border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; padding: 14px; }
    textarea, input, select, button { width: 100%; box-sizing: border-box; font: inherit; font-size: 16px; }
    textarea, input, select { background: #0f1530; border: 1px solid rgba(255,255,255,0.12); color: var(--text); border-radius: 12px; padding: 12px 14px; }
    textarea { min-height: 130px; resize: vertical; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .row > * { flex: 1; min-width: 110px; }
    .pill { display: inline-flex; align-items: center; gap: 8px; background: #0f1530; border: 1px solid rgba(255,255,255,0.12); padding: 10px 12px; border-radius: 100px; font-size: 13px; color: var(--muted); min-height: 44px; }
    .pill input { width: auto; }
    .btn { cursor: pointer; padding: 12px 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.16); background: linear-gradient(180deg, #172145, #121a3a); color: var(--text); min-height: 44px; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
    .btn:active { transform: translateY(1px); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .small { font-size: 12px; color: var(--muted); }
    .badge { display:inline-block; padding:6px 10px; border-radius:10px; background:#10224a; border:1px solid rgba(255,255,255,0.08); color: var(--accent2); font-size: 12px; }
    .ok { color: var(--good); } .warn { color: var(--warn); } .bad { color: var(--bad); }
    .cards { display:grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .card { background:#0f1530; border: 1px solid rgba(255,255,255,0.12); border-radius:12px; padding:10px; }
    details { background:#0e1632; border:1px solid rgba(255,255,255,0.08); border-radius:10px; padding: 8px 10px; }
    summary { cursor: pointer; color: var(--accent2); }
    .hidden { display: none; }
    footer { margin: 20px 0; color: var(--muted); font-size: 12px; padding-bottom: env(safe-area-inset-bottom); }
    .flex { display:flex; gap: 10px; flex-wrap: wrap; }
    .flex > * { flex: 1; }
    .kudos { font-size: 12px; color: var(--muted); text-align: right; }
    .ios-tip { background:#10224a; border:1px solid rgba(255,255,255,0.12); padding:10px; border-radius:10px; margin-top:8px;}
    @media (max-width: 820px) { .grid { grid-template-columns: 1fr; } .cards { grid-template-columns: 1fr 1fr; } h1 { font-size: 20px; } }
    @media (max-width: 420px) { .cards { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>LinguaLab <span class="spark">âš¡</span><span class="small"> â€” NL â‡„ EN â‡„ PT-BR</span></h1>
      <div class="small">PWA: offline, op beginscherm, standalone modus.</div>
    </div>
  </header>

  <main class="wrap" id="app" style="padding-bottom: env(safe-area-inset-bottom);">
    <div id="iosWarning" class="ios-tip hidden"></div>

    <div class="grid">
      <section class="panel">
        <h2>ğŸ—£ï¸ Invoer</h2>
        <textarea id="inputText" placeholder="Typ of dicteer (iOS toetsenbord-microfoon) NL/EN/PT-BRâ€¦"
          autocapitalize="sentences" autocorrect="on" spellcheck="true"></textarea>
        <div class="row" style="margin-top:8px;">
          <select id="inLang">
            <option value="auto">Detecteer automatisch</option>
            <option value="nl">Nederlands</option>
            <option value="en">Engels</option>
            <option value="pt">Portugees (BR)</option>
          </select>
          <select id="outLang">
            <option value="pt">Portugees (BR)</option>
            <option value="nl">Nederlands</option>
            <option value="en">Engels</option>
          </select>
        </div>
        <div class="row" style="margin-top:8px;">
          <label class="pill"><input type="checkbox" id="carioca" checked /> Carioca/informeel</label>
          <label class="pill"><input type="checkbox" id="explain" checked /> Leg grammatica uit</label>
          <label class="pill"><input type="checkbox" id="toneStrict" /> Strenge docent-modus</label>
        </div>
        <div class="row" style="margin-top:8px;">
          <button class="btn" id="btnTranslate">â†”ï¸ Vertaal & Leg uit</button>
          <button class="btn" id="btnSpeak">ğŸ”ˆ Voorlezen</button>
          <button class="btn" id="btnListen">ğŸ™ï¸ Luister (STT)</button>
          <button class="btn" id="btnPaste">ğŸ“‹ Plak</button>
          <button class="btn" id="btnClear">ğŸ§¹ Leeg</button>
        </div>
        <div class="row" style="margin-top:8px;">
          <select id="voiceSelect"><option value="">iOS stem (automatisch)</option></select>
          <button class="btn" id="btnPrimeAudio">ğŸšï¸ Audio inschakelen</button>
          <button class="btn" id="btnInstall" class="hidden">â• Voeg toe aan beginscherm</button>
        </div>
      </section>

      <section class="panel">
        <h2>ğŸ“˜ Output</h2>
        <div id="output" class="mono" style="white-space:pre-wrap;"></div>
      </section>
    </div>

    <section class="panel" style="margin-top:16px;">
      <h2>ğŸ¯ Vervoegingsspel (PT-BR, zonder â€œtu/vÃ³sâ€)</h2>
      <div class="row">
        <select id="verbSelect"></select>
        <select id="tenseSelect">
          <option value="pres">Tegenwoordige tijd</option>
          <option value="pret">Voltooid verleden (pretÃ©rito perfeito)</option>
          <option value="imp">Onvoltooid verleden (pretÃ©rito imperfeito)</option>
        </select>
        <button class="btn" id="startDrill">Start</button>
        <span id="score" class="badge">score: 0</span>
      </div>
      <div id="drillArea" class="hidden" style="margin-top:10px;">
        <div id="prompt" class="mono"></div>
        <div class="row" style="margin-top:8px;">
          <input id="answer" placeholder="Typ de juiste vormâ€¦" inputmode="latin" autocapitalize="off" autocorrect="off" />
          <button class="btn" id="check">Check</button>
        </div>
        <div id="feedback" class="small" style="margin-top:6px;"></div>
      </div>
      <details style="margin-top:10px;">
        <summary>Welke personen worden gebruikt?</summary>
        <div class="small">eu, vocÃª, ele/ela, a gente, nÃ³s, vocÃªs, eles/elas (BR: geen â€œtu/vÃ³sâ€).</div>
      </details>
    </section>

    <section class="panel" style="margin-top:16px;">
      <h2>ğŸ§  SRS Mini-Deck (Topwoorden) + eigen woorden importeren</h2>
      <div class="cards" id="cardArea"></div>
      <div class="row" style="margin-top:10px;">
        <input id="csv" type="file" accept=".csv" />
        <button class="btn" id="importBtn">Importeer CSV (pt,nl,en)</button>
        <span class="small">Voorbeeld CSV: <code>bom,goed,good</code></span>
      </div>
    </section>

    <footer>
      <div class="flex">
        <div>Tip: na installatie kun je LinguaLab offline gebruiken (behalve STT in iOS Safari).</div>
        <div class="kudos">Gemaakt voor Tom â€” PWA</div>
      </div>
    </footer>
  </main>

  <script>
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
const iOSWarn = document.getElementById('iosWarning');
if (isIOS) {
  iOSWarn.classList.remove('hidden');
  iOSWarn.innerHTML = "ğŸ“± iPhone gedetecteerd: Web Speech STT is niet beschikbaar in Safari iOS. " +
    "Gebruik de toetsenbord-microfoon voor dicteren. Installeer als PWA voor fullscreen & offline.";
}

/* Service Worker registration */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(console.error);
  });
}

/* PWA install prompt (Android/desktop) */
let deferredPrompt = null;
const btnInstall = document.getElementById('btnInstall');
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  btnInstall.classList.remove('hidden');
});
btnInstall?.addEventListener('click', async ()=>{
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt = null;
  btnInstall.classList.add('hidden');
});

/* ===== Data ===== */
const dict = {
  pt2en: {
    "olÃ¡": "hello", "oi": "hi", "bom": "good", "boa": "good (fem)",
    "comer": "to eat", "beber": "to drink", "falar": "to speak",
    "correr": "to run", "trabalhar": "to work", "voltar": "to return",
    "deixar": "to let/leave", "estar": "to be (state)", "ser": "to be (essence)",
    "ir": "to go", "ter": "to have", "fazer": "to do/make", "poder": "can",
    "querer": "to want", "dizer": "to say", "ver": "to see", "dar": "to give",
    "ficar": "to stay/become", "precisar": "to need", "gostar": "to like",
    "cafÃ©": "coffee", "fome": "hunger", "Ã¡gua": "water", "dinheiro": "money",
    "grana": "money (slang)", "maneiro": "cool", "cadÃª": "where is",
    "agora": "now", "hoje": "today", "amanhÃ£": "tomorrow", "ontem": "yesterday",
    "trÃ¢nsito": "traffic", "trampo": "work/job (slang)", "rolÃª": "hangout (slang)"
  },
  en2pt: {},
  nl2en: {
    "hallo":"hello","goed":"good","water":"water","eten":"to eat",
    "drinken":"to drink","spreken":"to speak","rennen":"to run","werken":"to work",
    "terugkomen":"to return","laten":"to let","zijn":"to be","gaan":"to go",
    "hebben":"to have","doen":"to do","kunnen":"can","willen":"to want",
    "zeggen":"to say","zien":"to see","geven":"to give","blijven":"to stay",
    "nodig hebben":"to need","leuk vinden":"to like","koffie":"coffee","honger":"hunger",
    "verkeer":"traffic","baantje":"job","afspraak":"appointment"
  },
  en2nl: {}
};
for (const [pt,en] of Object.entries(dict.pt2en)) { dict.en2pt[en] = pt; }
for (const [nl,en] of Object.entries(dict.nl2en)) { dict.en2nl[en] = nl; }

const slangPT = [
  {from:/vocÃª estÃ¡/gi, to:"cÃª tÃ¡"},
  {from:/estÃ¡/gi, to:"tÃ¡"},
  {from:/vocÃª/gi, to:"cÃª"},
  {from:/estou/gi, to:"tÃ´"},
  {from:/para o/gi, to:"pro"},
  {from:/para a/gi, to:"pra"},
];

/* ===== Conjugations ===== */
const verbs = {
  "falar": { pres:["falo","fala","fala","fala","falamos","falam","falam"], pret:["falei","falou","falou","falou","falamos","falaram","falaram"], imp:["falava","falava","falava","falava","falÃ¡vamos","falavam","falavam"] },
  "comer": { pres:["como","come","come","come","comemos","comem","comem"], pret:["comi","comeu","comeu","comeu","comemos","comeram","comeram"], imp:["comia","comia","comia","comia","comÃ­amos","comiam","comiam"] },
  "beber": { pres:["bebo","bebe","bebe","bebe","bebemos","bebem","bebem"], pret:["bebi","bebeu","bebeu","bebeu","bebemos","beberam","beberam"], imp:["bebia","bebia","bebia","bebia","bebÃ­amos","bebiam","bebiam"] },
  "trabalhar": { pres:["trabalho","trabalha","trabalha","trabalha","trabalhamos","trabalham","trabalham"], pret:["trabalhei","trabalhou","trabalhou","trabalhou","trabalhamos","trabalharam","trabalharam"], imp:["trabalhava","trabalhava","trabalhava","trabalhava","trabalhÃ¡vamos","trabalhavam","trabalhavam"] },
  "correr": { pres:["corro","corre","corre","corre","corremos","correm","correm"], pret:["corri","correu","correu","correu","corremos","correram","correram"], imp:["corria","corria","corria","corria","corrÃ­amos","corriam","corriam"] },
  "voltar": { pres:["volto","volta","volta","volta","voltamos","voltam","voltam"], pret:["voltei","voltou","voltou","voltou","voltamos","voltaram","voltaram"], imp:["voltava","voltava","voltava","voltava","voltÃ¡vamos","voltavam","voltavam"] },
  "deixar": { pres:["deixo","deixa","deixa","deixa","deixamos","deixam","deixam"], pret:["deixei","deixou","deixou","deixou","deixamos","deixaram","deixaram"], imp:["deixava","deixava","deixava","deixava","deixÃ¡vamos","deixavam","deixavam"] },
  "ser": { pres:["sou","Ã©","Ã©","Ã©","somos","sÃ£o","sÃ£o"], pret:["fui","foi","foi","foi","fomos","foram","foram"], imp:["era","era","era","era","Ã©ramos","eram","eram"] },
  "estar": { pres:["estou","estÃ¡","estÃ¡","estÃ¡","estamos","estÃ£o","estÃ£o"], pret:["estive","esteve","esteve","esteve","estivemos","estiveram","estiveram"], imp:["estava","estava","estava","estava","estÃ¡vamos","estavam","estavam"] },
  "ir": { pres:["vou","vai","vai","vai","vamos","vÃ£o","vÃ£o"], pret:["fui","foi","foi","foi","fomos","foram","foram"], imp:["ia","ia","ia","ia","Ã­amos","iam","iam"] },
  "ter": { pres:["tenho","tem","tem","tem","temos","tÃªm","tÃªm"], pret:["tive","teve","teve","teve","tivemos","tiveram","tiveram"], imp:["tinha","tinha","tinha","tinha","tÃ­nhamos","tinham","tinham"] },
  "fazer": { pres:["faÃ§o","faz","faz","faz","fazemos","fazem","fazem"], pret:["fiz","fez","fez","fez","fizemos","fizeram","fizeram"], imp:["fazia","fazia","fazia","fazia","fazÃ­amos","faziam","faziam"] },
  "poder": { pres:["posso","pode","pode","pode","podemos","podem","podem"], pret:["pude","pÃ´de","pÃ´de","pÃ´de","pudemos","puderam","puderam"], imp:["podia","podia","podia","podia","podÃ­amos","podiam","podiam"] },
  "querer": { pres:["quero","quer","quer","quer","queremos","querem","querem"], pret:["quis","quis","quis","quis","quisemos","quiseram","quiseram"], imp:["queria","queria","queria","queria","querÃ­amos","queriam","queriam"] },
  "dizer": { pres:["digo","diz","diz","diz","dizemos","dizem","dizem"], pret:["disse","disse","disse","disse","dissemos","disseram","disseram"], imp:["dizia","dizia","dizia","dizia","dizÃ­amos","diziam","diziam"] },
  "ver": { pres:["vejo","vÃª","vÃª","vÃª","vemos","veem","veem"], pret:["vi","viu","viu","viu","vimos","viram","viram"], imp:["via","via","via","via","vÃ­amos","viam","viam"] },
  "dar": { pres:["dou","dÃ¡","dÃ¡","dÃ¡","damos","dÃ£o","dÃ£o"], pret:["dei","deu","deu","deu","demos","deram","deram"], imp:["dava","dava","dava","dava","dÃ¡vamos","davam","davam"] },
  "ficar": { pres:["fico","fica","fica","fica","ficamos","ficam","ficam"], pret:["fiquei","ficou","ficou","ficou","ficamos","ficaram","ficaram"], imp:["ficava","ficava","ficava","ficava","ficÃ¡vamos","ficavam","ficavam"] },
  "precisar": { pres:["preciso","precisa","precisa","precisa","precisamos","precisam","precisam"], pret:["precisei","precisou","precisou","precisou","precisamos","precisaram","precisaram"], imp:["precisava","precisava","precisava","precisava","precisÃ¡vamos","precisavam","precisavam"] },
  "gostar": { pres:["gosto","gosta","gosta","gosta","gostamos","gostam","gostam"], pret:["gostei","gostou","gostou","gostou","gostamos","gostaram","gostaram"], imp:["gostava","gostava","gostava","gostava","gostÃ¡vamos","gostavam","gostavam"] }
};
const persons = ["eu","vocÃª","ele/ela","a gente","nÃ³s","vocÃªs","eles/elas"];

function conjugate(verb, tenseIndex, personIndex) {
  if (!verbs[verb]) return null;
  const key = ["pres","pret","imp"][tenseIndex];
  return verbs[verb][key][personIndex];
}

/* ===== Translator ===== */
function detectLang(text) {
  const t = text.toLowerCase();
  if (/[Ã£ÃµÃ§Ã¡Ã©Ã­Ã³ÃºÃ¢ÃªÃ´]/.test(t) || /\b(vocÃª|tÃ¡|cadÃª|grana|maneiro|a gente)\b/.test(t)) return "pt";
  if (/[Ã¤Ã«Ã¯Ã¶Ã¼]/.test(t) || /\b(het|de|een|ik|jij|wij|jullie|niet)\b/.test(t)) return "nl";
  if (/\b(the|and|you|we|is|are|do|does|not)\b/.test(t)) return "en";
  return "en";
}
function translateSimple(text, from, to, carioca) {
  if (from === "auto") from = detectLang(text);
  const words = text.toLowerCase().split(/(\s+|[,.!?;:()]+)/);
  function wordMap(w, src, dst) {
    if (!w.trim()) return w;
    if (src==="pt" && dst==="en") return dict.pt2en[w] || w;
    if (src==="en" && dst==="pt") return dict.en2pt[w] || w;
    if (src==="nl" && dst==="en") return dict.nl2en[w] || w;
    if (src==="en" && dst==="nl") return dict.en2nl[w] || w;
    if (src==="nl" && dst==="pt") return dict.en2pt[ dict.nl2en[w] ] || w;
    if (src==="pt" && dst==="nl") return dict.en2nl[ dict.pt2en[w] ] || w;
    return w;
  }
  const out = words.map(w => wordMap(w, from, to)).join("");
  let finalOut = out;
  if (to==="pt" && carioca) slangPT.forEach(rule => { finalOut = finalOut.replace(rule.from, rule.to); });
  return finalOut;
}

/* ===== Grammar notes ===== */
function explain(text, inLang, outLang, carioca, strict) {
  const notes = [];
  if (inLang==="auto") inLang = detectLang(text);
  const t = text.trim();

  if (inLang==="pt") {
    if (/\b(ontem|ontem Ã  noite)\b/i.test(t) || /\b(foi|fui|fomos|foram|dei|fiz|vi|disse)\b/i.test(t)) {
      notes.push("â±ï¸ PT: pretÃ©rito perfeito (afgeronde verleden) gedetecteerd.");
    }
    if (/\b(antigamente|sempre|costumava)\b/i.test(t) || /\b(era|estava|fazia|tinha)\b/i.test(t)) {
      notes.push("â±ï¸ PT: pretÃ©rito imperfeito (voortdurend verleden) mogelijk.");
    }
    if (/\b(tÃ´|tÃ¡|cÃª)\b/i.test(t)) {
      notes.push("ğŸ—ºï¸ Carioca/informeel: â€˜tÃ´/tÃ¡/cÃªâ€™ â‡¢ formeel is â€˜estou/estÃ¡/vocÃªâ€™.");
    }
    if (/\ba gente\b/i.test(t)) {
      notes.push("ğŸ‘¥ â€˜a genteâ€™ gebruikt 3e pers. enkelvoudsvorm (informeel voor â€˜nÃ³sâ€™).");
    }
  }
  if (inLang==="nl") {
    if (/\b(na|voor)\b.*\b(werken|werk)\b/i.test(t)) {
      notes.push("âš™ï¸ NL â†’ PT: â€˜na het werkâ€™ â‡¢ â€˜depois do trabalhoâ€™; â€˜voor het werkâ€™ â‡¢ â€˜antes do trabalhoâ€™.");
    }
    if (/\b(gaan)\b.*\b(hardlopen|rennen)\b/i.test(t)) {
      notes.push("ğŸƒ â€˜gaan hardlopenâ€™ â‡¢ PT: â€˜vou correrâ€™.");
    }
  }
  if (outLang==="pt" && carioca) {
    notes.push("ğŸ§ Slang-modus: â€˜paraâ€™ â†’ â€˜pra/proâ€™, â€˜vocÃª estÃ¡â€™ â†’ â€˜cÃª tÃ¡â€™, â€˜estouâ€™ â†’ â€˜tÃ´â€™.");
  }
  if (strict) notes.push("ğŸ“ Strenge modus: directe, korte feedback.");
  if (!notes.length) notes.push("â„¹ï¸ Geen specifieke opmerkingen â€” zin lijkt prima.");
  return notes.join("\n");
}

/* ===== TTS (with voice selection) ===== */
let selectedVoice = null;
function loadVoices() {
  const select = document.getElementById("voiceSelect");
  function populate() {
    const voices = speechSynthesis.getVoices();
    select.innerHTML = '<option value=\"\">iOS stem (automatisch)</option>';
    voices.forEach((v, idx) => {
      const opt = document.createElement("option");
      opt.value = String(idx);
      opt.textContent = `${v.name} â€” ${v.lang}`;
      select.appendChild(opt);
    });
  }
  populate();
  if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = populate;
  select.addEventListener("change", ()=>{
    const idx = parseInt(select.value, 10);
    selectedVoice = isNaN(idx) ? null : speechSynthesis.getVoices()[idx];
  });
}
function speak(text, lang) {
  if (!("speechSynthesis" in window)) { alert("Geen TTS in deze browser."); return; }
  const u = new SpeechSynthesisUtterance(text);
  const map = {nl:"nl-NL", en:"en-US", pt:"pt-BR"};
  u.lang = map[lang] || "pt-BR";
  if (selectedVoice) u.voice = selectedVoice;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

/* ===== STT ===== */
let listening = false;
let recognition = null;
function listen(lang) {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { alert("Spraakherkenning niet beschikbaar in deze browser."); return; }
  if (listening) { recognition.stop(); return; }
  recognition = new SR();
  recognition.lang = ({nl:"nl-NL", en:"en-US", pt:"pt-BR"})[lang] || "pt-BR";
  recognition.interimResults = true;
  recognition.onresult = (e)=>{
    const t = Array.from(e.results).map(r=>r[0].transcript).join("");
    document.getElementById("inputText").value = t;
  };
  recognition.onend = ()=>{ listening = false; document.getElementById("btnListen").innerText = "ğŸ™ï¸ Luister (STT)"; };
  recognition.start();
  listening = true;
  document.getElementById("btnListen").innerText = "â¹ï¸ Stop luisteren";
}

/* ===== SRS mini ===== */
const seedDeck = [
  ["bom","goed","good"], ["ruim","slecht","bad"], ["Ã¡gua","water","water"],
  ["comer","eten","to eat"], ["beber","drinken","to drink"],
  ["falar","spreken","to speak"], ["correr","rennen","to run"],
  ["trabalhar","werken","to work"], ["dinheiro","geld","money"],
  ["grana","poen (slang)","money (slang)"], ["maneiro","gaaf","cool"],
  ["cadÃª?","waar is?","where is?"], ["hoje","vandaag","today"],
  ["amanhÃ£","morgen","tomorrow"], ["ontem","gisteren","yesterday"]
];
function renderDeck() {
  const area = document.getElementById("cardArea");
  area.innerHTML = "";
  seedDeck.forEach(([pt,nl,en], i)=>{
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="small">PT-BR</div>
      <div class="mono" style="font-size:16px;margin:4px 0;">${pt}</div>
      <div class="small">NL Â· EN</div>
      <div class="mono">${nl} Â· ${en}</div>
      <div class="row" style="margin-top:8px;">
        <button class="btn" data-i="${i}" data-q="pt">Ik weet het</button>
        <button class="btn" data-i="${i}" data-q="nl">Ik twijfel</button>
      </div>
    `;
    area.appendChild(card);
  });
  area.addEventListener("click", (e)=>{
    if (e.target.tagName==="BUTTON") {
      const i = +e.target.dataset.i;
      const q = e.target.dataset.q;
      const item = seedDeck.splice(i,1)[0];
      if (q==="pt") seedDeck.push(item); else seedDeck.splice(Math.min(i+2, seedDeck.length),0,item);
      renderDeck();
    }
  }, {once:true});
}

/* ===== UI Wiring ===== */
function populateVerbs() {
  const sel = document.getElementById("verbSelect");
  Object.keys(verbs).sort().forEach(v=>{
    const opt = document.createElement("option");
    opt.value = v; opt.textContent = v;
    sel.appendChild(opt);
  });
}
let drill = null;
function startDrill() {
  const v = document.getElementById("verbSelect").value;
  const t = document.getElementById("tenseSelect").value;
  drill = {verb:v, tense:t, score:0};
  document.getElementById("score").textContent = "score: 0";
  document.getElementById("drillArea").classList.remove("hidden");
  nextPrompt();
}
function nextPrompt() {
  const p = Math.floor(Math.random()*persons.length);
  drill.p = p;
  const niceTense = {pres:"presente",pret:"pretÃ©rito perfeito",imp:"pretÃ©rito imperfeito"}[drill.tense];
  document.getElementById("prompt").textContent = `Conjuge â€œ${drill.verb}â€ â†’ ${niceTense} â€” ${persons[p]}`;
  const ans = document.getElementById("answer");
  ans.value = "";
  document.getElementById("feedback").textContent = "";
  ans.focus({preventScroll:true});
}
function checkAnswer() {
  const tIdx = {pres:0,pret:1,imp:2}[drill.tense];
  const correct = conjugate(drill.verb, tIdx, drill.p);
  const got = document.getElementById("answer").value.trim().toLowerCase();
  const fb = document.getElementById("feedback");
  if (got === (correct||"").toLowerCase()) {
    drill.score += 1;
    document.getElementById("score").textContent = `score: ${drill.score}`;
    fb.innerHTML = `<span class="ok">âœ“ Correct</span>`;
    setTimeout(nextPrompt, 500);
  } else {
    fb.innerHTML = `<span class="bad">âœ—</span> Juiste vorm: <b>${correct}</b> <span class="small">(${persons[drill.p]})</span>`;
  }
}

/* ===== Actions ===== */
document.addEventListener("DOMContentLoaded", ()=>{
  populateVerbs();
  renderDeck();
  loadVoices();

  const btnListen = document.getElementById("btnListen");
  if (isIOS) {
    btnListen.classList.add("hidden");
  } else {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) btnListen.classList.add("hidden");
  }

  document.getElementById("btnTranslate").addEventListener("click", ()=>{
    const txt = document.getElementById("inputText").value;
    const inLang = document.getElementById("inLang").value;
    const outLang = document.getElementById("outLang").value;
    const carioca = document.getElementById("carioca").checked;
    const strict = document.getElementById("toneStrict").checked;
    const trans = translateSimple(txt, inLang, outLang, carioca);
    let output = `â–¶ Vertaling (${outLang}):\n${trans}\n`;
    if (document.getElementById("explain").checked) {
      const expl = explain(txt, inLang, outLang, carioca, strict);
      output += `\nâ–¶ Uitleg:\n${expl}\n`;
    }
    document.getElementById("output").textContent = output;
  }, {passive:true});

  document.getElementById("btnSpeak").addEventListener("click", ()=>{
    const outLang = document.getElementById("outLang").value;
    const out = document.getElementById("output").textContent;
    const lines = out.split(/\n/).filter(Boolean);
    const toSpeak = lines.slice(1).join(" ").trim() || out;
    speak(toSpeak, outLang);
  });

  btnListen.addEventListener("click", ()=>{
    const inLang = document.getElementById("inLang").value === "auto" ? "pt" : document.getElementById("inLang").value;
    listen(inLang);
  });

  document.getElementById("btnPaste").addEventListener("click", async ()=>{
    try {
      const txt = await navigator.clipboard.readText();
      document.getElementById("inputText").value = txt;
    } catch(e) {
      alert("Clipboard niet toegankelijk. Plak handmatig in het invoerveld.");
    }
  });

  document.getElementById("btnClear").addEventListener("click", ()=>{
    document.getElementById("inputText").value = "";
    document.getElementById("output").textContent = "";
  });

  document.getElementById("startDrill").addEventListener("click", startDrill);
  document.getElementById("check").addEventListener("click", checkAnswer);
  document.getElementById("answer").addEventListener("keydown", (e)=>{
    if (e.key==="Enter") checkAnswer();
  });

  document.getElementById("importBtn").addEventListener("click", ()=>{
    const f = document.getElementById("csv").files[0];
    if (!f) return alert("Kies eerst een CSV.");
    const reader = new FileReader();
    reader.onload = ()=>{
      const lines = reader.result.split(/\r?\n/).filter(Boolean);
      lines.forEach(line=>{
        const [pt,nl,en] = line.split(",").map(s=>s.trim());
        if (pt && nl && en) seedDeck.push([pt,nl,en]);
      });
      renderDeck();
      alert("GeÃ¯mporteerd!");
    };
    reader.readAsText(f, "utf-8");
  });

  document.getElementById("btnPrimeAudio").addEventListener("click", ()=>{
    const s = new SpeechSynthesisUtterance(".");
    s.volume = 0;
    speechSynthesis.speak(s);
  }, {passive:true});
});
  </script>
</body>
</html>
