<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>LinguaLab ‚Äî Vertalen + SRS 2.0</title>
  <meta name="theme-color" content="#0b1021">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="stylesheet" href="./ll-brazil-ipad-v2.css">
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    textarea, select, input, button { -webkit-appearance: none; appearance: none; background-clip: padding-box; box-sizing: border-box; }
    :root { --bg:#0c0e10; --panel:rgba(255,255,255,0.08); --panel-strong:rgba(255,255,255,0.12);
      --text:#e8ecf1; --muted:#a8b0ba; --hairline:1px solid rgba(255,255,255,0.14);
      --backdrop:blur(18px) saturate(130%); --radius:18px; --shadow: 0 10px 30px rgba(0,0,0,0.25);
      --blue:#60a5fa; --green:#34d399; --orange:#f59e0b; --purple:#a78bfa; }
    @media (prefers-color-scheme: light) {
      :root { --bg:#f6f7fb; --panel:rgba(255,255,255,0.65); --panel-strong:rgba(255,255,255,0.8);
        --text:#0b1520; --muted:#536070; --hairline:1px solid rgba(0,0,0,0.08); --shadow:0 8px 20px rgba(0,0,0,0.12); }
    }
    body{font-family:-apple-system,BlinkMacSystemFont,'SF Pro Text',system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    header { position:sticky; top:0; z-index:10; backdrop-filter:var(--backdrop);
      background:linear-gradient(180deg,rgba(0,0,0,.25),rgba(0,0,0,.05)); border-bottom:var(--hairline);
      padding-top: env(safe-area-inset-top); }
    .wrap { max-width:980px; margin:0 auto; padding:16px; }
    h1 { margin:0; font-size:22px; display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .header-actions { display:flex; gap:8px; flex-wrap:wrap; }
    .btn { border:var(--hairline); background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.06)); border-radius:14px; padding:8px 10px; cursor:pointer; min-height:36px; color:var(--text); text-decoration:none; }
    .subtitle { color:var(--muted); font-size:13px; margin-top:4px; }
    .grid { display:grid; grid-template-columns:1.05fr .95fr; gap:16px; margin-top:16px; }
    @media (max-width:900px){ .grid{ grid-template-columns:1fr; } }
    .panel { background:var(--panel); border:var(--hairline); border-radius:18px; backdrop-filter:var(--backdrop); padding:14px; box-shadow:var(--shadow); overflow:hidden; }
    textarea, select, button { width:100%; font:inherit; font-size:16px; }
    textarea { background:var(--panel-strong); border:var(--hairline); border-radius:12px; min-height:140px; padding:12px 14px; color:var(--text); }
    .row { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .small { font-size:12px; color:var(--muted); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace; white-space:pre-wrap; }
    .tags { line-height:2.1; font-size:17px; white-space: normal; word-wrap: break-word; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.22); background:var(--panel-strong); margin:2px 2px; }
    .pill.subj { background:rgba(96,165,250,.18); border-color:rgba(96,165,250,.55); }
    .pill.verb { background:rgba(52,211,153,.18); border-color:rgba(52,211,153,.55); }
    .pill.clause { background:rgba(245,158,11,.18); border-color:rgba(245,158,11,.55); }
    .pill.prep { background:rgba(167,139,250,.18); border-color:rgba(167,139,250,.55); }
    .actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .badge { display:inline-flex; align-items:center; gap:6px; border:var(--hairline); background:var(--panel-strong); border-radius:999px; padding:6px 10px; }
  </style>
</head>
<body>
  <div id="ll-header"></div>
  <script src="./ll-nav.js" defer></script>

  <main class="wrap">
    <div class="grid">
      <section class="panel">
        <h2>üó£Ô∏è Invoer</h2>
        <textarea id="input" placeholder="Typ of dicteer hier‚Ä¶"></textarea>
        <div class="row">
          <select id="source">
            <option value="auto">Detecteer automatisch</option>
            <option value="nl">Nederlands</option>
            <option value="en">Engels</option>
            <option value="pt">Portugees (BR)</option>
          </select>
          <select id="target">
            <option value="pt">Portugees (BR)</option>
            <option value="nl">Nederlands</option>
            <option value="en">Engels</option>
          </select>
        </div>
        <div class="row">
          <label class="small"><input type="checkbox" id="carioca" checked> Carioca/informeel PT-BR</label>
        </div>
        <div class="row">
          <button class="btn" id="btnTranslate">‚ÜîÔ∏è Vertaal & Analyseer</button>
          <button class="btn" id="btnSwap">‚ÜïÔ∏è Wissel talen</button>
          <button class="btn" id="btnClear">üßπ Leeg</button>
        </div>
        <div class="small" id="status"></div>
      </section>

      <section class="panel">
        <h2>üìò Output</h2>
        <div id="output" class="mono">Klaar voor input‚Ä¶</div>
        <div class="actions">
          <button class="btn" id="btnCopy">üîó Kopieer</button>
          <button class="btn" id="btnShare">‚ÜóÔ∏è Deel</button>
          <button class="btn" id="btnSpeak">üîä Voorlezen</button>
          <button class="btn" id="btnSaveFav">‚≠ê Bewaar</button>
          <button class="btn" id="btnSaveCard">üìö Oefenen</button>
        </div>
        <div class="row" style="margin-top:6px">
          <button class="btn" id="btnViewFavs" aria-haspopup="dialog">‚≠ê Bekijk favorieten</button>
          <button class="btn" id="btnViewCards" aria-haspopup="dialog">üìö Bekijk kaarten</button>
        </div>

        <div id="analysis" class="tags" style="margin-top:10px;"></div>
        <div id="notes" class="small" style="margin-top:8px;"></div>
      </section>
    </div>
    <div id="installTip" class="badge" style="margin-top:12px; display:none;">üëâ Tip: zet op je beginscherm via ‚ÄúDeel‚Äù ‚Üí ‚ÄúZet op beginscherm‚Äù.</div>
  
  <!-- Modal: lists for Favorieten and Kaarten -->
  <div class="backdrop" id="listBg" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.28);backdrop-filter:blur(2px)"></div>
  <div class="sheet" id="listSheet" role="dialog" aria-modal="true" aria-labelledby="listTitle" style="display:none;position:fixed;inset:auto 0 0 0;max-height:70vh;overflow:auto;background:var(--bg);border:var(--hairline);border-radius:16px 16px 0 0;box-shadow:var(--shadow)">
    <div style="position:sticky;top:0;background:inherit;border-bottom:var(--hair);padding:10px 12px;display:flex;align-items:center;gap:8px">
      <h3 id="listTitle" style="margin:0;flex:1 0 auto">Lijsten</h3>
      <button class="btn" id="listClose" aria-label="Sluiten">‚úï</button>
    </div>
    <div id="listContent" style="padding:12px"></div>
  </div>
</main>

  <!-- Popup for grammar items -->
  <div class="backdrop" id="popBg" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.28);backdrop-filter:blur(2px)"></div>
  <div class="sheet" id="pop" style="display:none;position:fixed;left:50%;bottom:12px;transform:translate(-50%,15px);max-width:92vw;background:var(--panel);border:var(--hairline);border-radius:16px;padding:12px;box-shadow:var(--shadow)">
    <h3 id="popTitle">Uitleg</h3>
    <div id="popText" class="small"></div>
    <div class="pair" style="background:var(--panel-strong);border:var(--hairline);border-radius:10px;padding:8px;margin-top:8px">
      <div class="small">Voorbeeld (NL)</div>
      <div id="popEgNl" class="mono"></div>
    </div>
    <div class="pair" style="background:var(--panel-strong);border:var(--hairline);border-radius:10px;padding:8px;margin-top:8px">
      <div class="small">Voorbeeld (doeltaal)</div>
      <div id="popEgTgt" class="mono"></div>
    </div>
    <div class="row">
      <button class="btn" id="btnUseExample">‚¨áÔ∏è Gebruik voorbeeld in invoer</button>
      <button class="btn" id="btnClosePop">Sluit</button>
    </div>
  </div>

  <script src="./srs2.js"></script>
  <script>
    /* === DeepL proxy + providers === */
    const DEEPL_PROXY = "https://deepl-proxy.8p8kxkrcnj.workers.dev";

    function normLang(x){
      if (!x) return "auto";
      const s = String(x).toLowerCase();
      if (s === "auto") return "auto";
      if (s.startsWith("nl")) return "NL";
      if (s.startsWith("en")) return "EN";
      if (["pt","pt-br","pt_br","ptbr","br"].includes(s)) return "PT-BR";
      return s.toUpperCase();
    }

    const ENDPOINTS = [
      { name:'DeepL (Cloudflare)', type:'deepl', base: DEEPL_PROXY },
      { name:'LibreTranslate .com', type:'libre', base:'https://libretranslate.com' },
      { name:'LibreTranslate .de', type:'libre', base:'https://libretranslate.de' },
      { name:'LibreTranslate astian', type:'libre', base:'https://translate.astian.org' },
      { name:'LibreTranslate fyed', type:'libre', base:'https://translate.fyed.xyz' },
      { name:'CORS proxy .com', type:'libre-proxy', base:'https://cors.isomorphic-git.org/https://libretranslate.com' },
      { name:'CORS proxy .de', type:'libre-proxy', base:'https://cors.isomorphic-git.org/https://libretranslate.de' },
      { name:'MyMemory', type:'mymemory', base:'https://api.mymemory.translated.net' }
    ];

    /* === KV sync laag === */
    const SYNC_BASE = 'https://lingualab-sync.8p8kxkrcnj.workers.dev';
    function getUID(){
      let id = localStorage.getItem('ll_uid');
      if (!id) { id = 'u_' + Math.random().toString(36).slice(2) + Date.now().toString(36); localStorage.setItem('ll_uid', id); }
      return id;
    }
    async function syncSave(key, value){
      try{
        const payload = typeof value === 'string' ? value : JSON.stringify(value);
        await fetch(`${SYNC_BASE}/save`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ uid:getUID(), key, value:payload })
        });
        return true;
      }catch{ return false; }
    }
    async function syncLoad(key){
      try{
        const res = await fetch(`${SYNC_BASE}/get?uid=${encodeURIComponent(getUID())}&key=${encodeURIComponent(key)}`);
        if (!res.ok) return null;
        const j = await res.json();
        return j?.value ?? null;
      }catch{ return null; }
    }

    // Local favorites (naast SRS) + sync
    const FKEY = 'll_favs_v1';
    function getFavs(){ try { return JSON.parse(localStorage.getItem(FKEY)) || []; } catch { return []; } }
    function setFavs(f){
      const data = JSON.stringify(f||[]);
      localStorage.setItem(FKEY, data);
      syncSave(FKEY, data);
    }

    // SRS sync helpers
    const SRS_KEY = (() => {
      for (let i = 0; i < localStorage.length; i++) {
        const k = localStorage.key(i);
        if (/^ll_srs_/i.test(k)) return k;
      }
      return 'll_srs_v1';
    })();
    function getSrsDeck(){
      try { return JSON.parse(localStorage.getItem(SRS_KEY)) || []; } catch { return []; }
    }
    function setSrsDeck(deck){
      const data = JSON.stringify(deck || []);
      localStorage.setItem(SRS_KEY, data);
      syncSave(SRS_KEY, data);
    }

    const statusEl = document.getElementById('status');
    const inputEl = document.getElementById('input');
    const outputEl = document.getElementById('output');
    const analysisEl = document.getElementById('analysis');
    const notesEl = document.getElementById('notes');
    const sourceEl = document.getElementById('source');
    const targetEl = document.getElementById('target');
    const cariocaEl = document.getElementById('carioca');

    async function copyText(text){
      try {
        if (navigator.clipboard && window.isSecureContext) { await navigator.clipboard.writeText(text); return true; }
        const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); return true;
      } catch { return false; }
    }
    async function shareText(title, text){
      try { if (navigator.share) { await navigator.share({title, text}); return true; } } catch {}
      return false;
    }

    async function callJSON(url, body){
      const ctrl = new AbortController();
      const resP = fetch(url, { method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'}, body:JSON.stringify(body), signal:ctrl.signal });
      const t = setTimeout(()=>ctrl.abort(), 12000);
      try {
        const res = await resP;
        if (!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        return data;
      } finally { clearTimeout(t); }
    }
    async function detectLangAuto(q, base, type){
      if (type && type.startsWith('libre')) {
        try {
          const data = await callJSON(base + '/detect', { q });
          if (Array.isArray(data) && data.length) {
            const best = data.sort((a,b)=>(b.confidence||0)-(a.confidence||0))[0];
            return best.language || 'en';
          }
        } catch(e){}
      }
      const t = q.toLowerCase();
      if (/[√£√µ√ß√°√©√≠√≥√∫√¢√™√¥]/u.test(t) || /voc√™|t√¥|t√°|cad√™|grana|a gente/u.test(t)) return 'pt';
      if (/(^|\b)(het|de|een|ik|jij|wij|jullie|niet)(\b|$)/u.test(t)) return 'nl';
      return 'en';
    }
    async function translateProvider(q, src, dst, provider){
      if (provider.type === 'deepl') {
        const body = { text: q, source_lang: normLang(src), target_lang: normLang(dst) };
        const res = await fetch(provider.base, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        if (!res.ok) throw new Error('DeepL HTTP ' + res.status);
        const j = await res.json();
        const text = j?.text || (j?.translations && j.translations[0]?.text) || '';
        if (!text) throw new Error('Geen vertaling ontvangen van DeepL');
        return text;
      }
      if (provider.type==='libre' || provider.type==='libre-proxy'){
        let source = src;
        if (source==='auto') source = await detectLangAuto(q, provider.base, provider.type);
        const data = await callJSON(provider.base + '/translate', { q, source, target: dst, format:'text' });
        return data.translatedText || data;
      } else {
        let source = src;
        if (source==='auto') source = await detectLangAuto(q, provider.base, 'heuristic');
        const url = provider.base + '/get?q=' + encodeURIComponent(q) + '&langpair=' + source + '|' + dst;
        const r = await fetch(url); const j = await r.json();
        if (j?.responseStatus !== 200) throw new Error('MyMemory ' + (j?.responseStatus||'err'));
        return j?.responseData?.translatedText || '';
      }
    }
    async function translateWithChain(q, src, dst){
      let lastErr = null;
      for (const p of ENDPOINTS){
        try {
          statusEl.textContent = 'Proberen via ' + p.name + '‚Ä¶';
          const text = await translateProvider(q, src, dst, p);
          return { text, provider: p.name };
        } catch(e){ lastErr = e; }
      }
      throw lastErr || new Error('Geen provider beschikbaar');
    }

    const slangRules = [
      {from:/\bvoc√™ est√°\b/gi, to:'c√™ t√°'},
      {from:/\best√°\b/gi, to:'t√°'},
      {from:/\bvoc√™\b/gi, to:'c√™'},
      {from:/\bestou\b/gi, to:'t√¥'},
      {from:/\bpara o\b/gi, to:'pro'},
      {from:/\bpara a\b/gi, to:'pra'}
    ];
    function applyCarioca(pt){ let out=pt; slangRules.forEach(r=>out=out.replace(r.from,r.to)); return out; }

    // Tokenizer
    let WORD_RE;
    (function(){
      try {
        WORD_RE = new RegExp("\\\\p{L}+|\\\\d+|[^\\\\s\\\\p{L}\\\\d]", "gu");
        const test = "cora√ß√£o".match(WORD_RE);
        if (!test || test.length === 0) throw new Error("bad");
      } catch (e) {
        WORD_RE = /[A-Za-z√Ä-√ñ√ò-√∂√∏-√ø]+|\d+|[^\sA-Za-z√Ä-√ñ√ò-√∂√∏-√ø\d]/g;
      }
    })();
    function tokenizeUnicode(s){ return s.match(WORD_RE) || []; }

    const pronouns = { nl:['ik','jij','je','u','hij','zij','ze','wij','we','jullie','zij'],
                       en:['i','you','he','she','we','they'],
                       pt:['eu','voc√™','ele','ela','a','gente','n√≥s','voc√™s','eles','elas'] };
    const preps = { nl:['in','op','aan','met','voor','na','bij','naar','van','tot','onder','boven','tijdens','zonder','tegen','rond','door','over','uit'],
                    en:['in','on','at','to','for','from','with','by','about','over','under','between','without','during','against','through'],
                    pt:['em','no','na','num','numa','com','para','pra','pro','de','do','da','dos','das','por','sem','entre','sobre','at√©','a'] };
    const clauseMarkers = { nl:['dat','omdat','als','terwijl','wanneer','zodat','hoewel','die','waar','toen'],
                            en:['that','because','if','while','when','so','although','who','which','where'],
                            pt:['que','porque','se','enquanto','quando','para','embora','quem','onde'] };

    function analyzeSentence(sentence, lang){
      const words = tokenizeUnicode(sentence);
      const tags = [];
      const lower = words.map(w=>w.toLowerCase());

      const subjSet = new Set(pronouns[lang]||[]);
      for (let i=0;i<lower.length;i++){ if (subjSet.has(lower[i])) { tags.push({i,type:'subj'}); break; } }

      const prepSet = new Set(preps[lang]||[]);
      for (let i=0;i<lower.length;i++){ if (prepSet.has(lower[i])) tags.push({i,type:'prep'}); }

      const cm = new Set(clauseMarkers[lang]||[]);
      for (let i=0;i<lower.length;i++){ if (cm.has(lower[i])) tags.push({i,type:'clause'}); }

      for (let i=0;i<lower.length;i++){
        const w = lower[i];
        if ((lang==='en' && (/ing$|ed$|\w+s$/i.test(w))) ||
            (lang==='nl' && (/^ge\w+/i.test(w))) ||
            (lang==='pt' && (/(ei|ou|aram|ava|ia|amos|em|am|ou)$/i.test(w)))) {
          tags.push({i,type:'verb'});
        }
      }
      return { words, tags };
    }

    function renderTags(container, analysis){
      const { words, tags } = analysis;
      const map = new Map();
      tags.forEach(t=>{ if(!map.has(t.i)) map.set(t.i,[]); map.get(t.i).push(t.type); });
      container.innerHTML = '';
      for (let i=0;i<words.length;i++){
        const tok = words[i];
        const types = map.get(i) || [];
        if (types.length){
          const span = document.createElement('span');
          span.textContent = tok;
          span.className = 'pill ' + types.join(' ');
          span.dataset.types = types.join(',');
          container.appendChild(span);
        } else {
          container.appendChild(document.createTextNode(tok));
        }
        container.appendChild(document.createTextNode(' '));
      }
    }

    // Popover
    const popBg = document.getElementById('popBg');
    const pop = document.getElementById('pop');
    const popTitle = document.getElementById('popTitle');
    const popText  = document.getElementById('popText');
    const popEgNl  = document.getElementById('popEgNl');
    const popEgTgt = document.getElementById('popEgTgt');
    const btnUseExample = document.getElementById('btnUseExample');
    const btnClosePop = document.getElementById('btnClosePop');
    function pick(a){ return a[Math.floor(Math.random()*a.length)]; }
    const EG = {
      subj: ['Wij eten vanavond samen.','Zij komt morgen op bezoek.','Ik begrijp het nu beter.','Jullie kunnen hier wachten.','Hij werkt al jaren in Brazili√´.','Ik moet morgen vroeg opstaan.','Zij willen later verhuizen.','We spelen straks een potje.'],
      verb: ['We hebben het gisteren besproken.','Ik zal morgen vertrekken.','Ze waren aan het oefenen.','Hij probeert elke dag te lezen.','Ik ga straks koken.','We zijn te laat vertrokken.','Hij heeft het niet gezien.','Ze blijft nog even werken.'],
      clause: ['Omdat het regent, blijven we thuis.','Als ik tijd heb, bel ik je.','Toen hij aankwam, begonnen we meteen.','Hoewel het laat is, werken we door.','Voordat we vertrekken, controleren we de tickets.','Zodat iedereen het begrijpt, leg ik het rustig uit.','Als je wil, kunnen we later gaan.'],
      prep: ['Na het werk ga ik sporten.','Ze woont bij het park.','We reizen met de trein.','Ik wacht voor de deur.','Hij praat over zijn studie.','Ik kom uit Nederland.','Het boek ligt op tafel.','We lopen naar het strand.']
    };
    function openPop(type, tgt){
      const label = {subj:'Onderwerp', verb:'Werkwoord', clause:'Bijzin', prep:'Voorzetsel'}[type] || 'Uitleg';
      const expl = {
        subj:'Het onderwerp voert de handeling uit. Vergelijk de positie in beide talen.',
        verb:'Werkwoord(en) geven tijd/persoon aan. Let op hulpwerkwoorden en ge-/ing-vormen.',
        clause:'Bijzin-markers (dat/omdat/als/que) veranderen vaak de volgorde.',
        prep:'Voorzetsels verbinden woorden met plaats/tijd/richting (in/op/naar ‚Äî em/para/com).'
      }[type] || '';
      popTitle.textContent = label; popText.textContent = expl;
      const ex = pick(EG[type] || ['Voorbeeld niet beschikbaar.']);
      popEgNl.textContent = ex; btnUseExample.dataset.text = ex;
      popEgTgt.textContent = 'Vertalen‚Ä¶';
      popBg.style.display='block'; pop.style.display='block';
      translateWithChain(ex, 'nl', tgt).then(({text})=> popEgTgt.textContent = text)
      .catch(()=> popEgTgt.textContent = '(Kon voorbeeld niet vertalen)');
    }
    analysisEl.addEventListener('click', (e)=>{
      const pill = e.target.closest('.pill'); if (!pill) return;
      const type = (pill.dataset.types||'').split(',')[0];
      openPop(type, targetEl.value);
    }, { passive:true });
    btnClosePop.addEventListener('click', ()=>{ popBg.style.display='none'; pop.style.display='none'; });
    btnUseExample.addEventListener('click', ()=>{ inputEl.value = btnUseExample.dataset.text || ''; sourceEl.value = 'nl'; popBg.style.display='none'; pop.style.display='none'; inputEl.focus(); });

    // Main actions
    document.getElementById('btnTranslate').addEventListener('click', async () => {
      const text = inputEl.value.trim();
      if (!text) { alert('Voer eerst een zin in.'); return; }
      const src = sourceEl.value; const dst = targetEl.value;

      statusEl.textContent = navigator.onLine ? 'Vertalen‚Ä¶' : 'Je bent offline ‚Äî kan mislukken.';
      outputEl.textContent = ''; analysisEl.textContent=''; notesEl.textContent='';

      try {
        let { text: translated, provider } = await translateWithChain(text, src, dst);
        if (dst==='pt' && cariocaEl.checked) translated = applyCarioca(translated);
        outputEl.textContent = `‚ñ∂ Vertaling (${dst}) via ${provider}:\n` + translated;

        const analysis = analyzeSentence(translated, dst);
        renderTags(analysisEl, analysis);
        notesEl.textContent = (dst==='pt' && cariocaEl.checked) ? 'üéß Slang-modus: para‚Üípra/pro, voc√™ est√°‚Üíc√™ t√°, estou‚Üít√¥.' : '';

        outputEl.dataset.last = translated;
        outputEl.dataset.meta = JSON.stringify({src, dst, input:text});
        statusEl.textContent = 'Klaar.';
      } catch (err) {
        statusEl.textContent = 'Kon niet vertalen.';
        outputEl.textContent = 'Fout: ' + (err?.message || 'onbekend');
      }
    });

    document.getElementById('btnSwap').addEventListener('click', () => {
      const s = sourceEl.value; const t = targetEl.value;
      if (s === 'auto') { alert('Bron op ‚Äúauto‚Äù kan niet worden gewisseld. Kies eerst een bron.'); return; }
      sourceEl.value = t; targetEl.value = s;
    });
    document.getElementById('btnClear').addEventListener('click', () => {
      inputEl.value=''; outputEl.textContent='Klaar voor input‚Ä¶'; analysisEl.textContent=''; notesEl.textContent=''; statusEl.textContent='';
    });
    document.getElementById('btnCopy').addEventListener('click', async () => {
      const txt = outputEl.dataset.last || ''; if (!txt) { alert('Nog geen vertaling.'); return; }
      const ok = await copyText(txt); statusEl.textContent = ok ? 'Gekopieerd.' : 'Kopi√´ren mislukt.';
    });
    document.getElementById('btnShare').addEventListener('click', async () => {
      const txt = outputEl.dataset.last || ''; if (!txt) { alert('Nog geen vertaling.'); return; }
      const ok = await shareText('LinguaLab ‚Äì vertaling', txt); statusEl.textContent = ok ? 'Deelvenster geopend.' : 'Delen niet ondersteund.';
    });
    function speak(text, lang){
      try { const u = new SpeechSynthesisUtterance(text); u.lang = lang==='pt' ? 'pt-BR' : (lang==='nl' ? 'nl-NL' : 'en-US'); speechSynthesis.cancel(); speechSynthesis.speak(u); return true; } catch { return false; }
    }
    document.getElementById('btnSpeak').addEventListener('click', () => {
      const txt = outputEl.dataset.last || ''; if (!txt) { alert('Nog geen vertaling.'); return; }
      const ok = speak(txt, targetEl.value); statusEl.textContent = ok ? 'Voorlezen‚Ä¶' : 'Voorlezen niet ondersteund.';
    });

    // Favorieten + SRS 2.0 add
    document.getElementById('btnSaveFav').addEventListener('click', () => {
      const txt = outputEl.dataset.last || ''; if (!txt) { alert('Nog geen vertaling om te bewaren.'); return; }
      const meta = JSON.parse(outputEl.dataset.meta || '{}');
      const favs = getFavs(); favs.unshift({ ts: Date.now(), input: meta.input||'', src: meta.src||'', dst: meta.dst||'', out: txt });
      setFavs(favs.slice(0,200)); statusEl.textContent = '‚≠ê Bewaard.';
    });
    document.getElementById('btnSaveCard').addEventListener('click', async ()=>{
      const txt = outputEl.dataset.last || ''; if (!txt) { alert('Nog geen vertaling.'); return; }
      const meta = JSON.parse(outputEl.dataset.meta || '{}');
      const res = await LL_SRS.add(meta.input||'', txt, meta.src||'auto', meta.dst||'pt', ['manual']);
      if (res.ok){
        statusEl.textContent = 'üìö Toegevoegd aan SRS.';
        // sync volledige deck
        setSrsDeck(getSrsDeck());
      } else {
        statusEl.textContent = 'Kaart bestond al.';
      }
    });

    // Install tip
    function maybeShowInstallTip(){
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
      if (!isStandalone) document.getElementById('installTip').style.display = 'inline-flex';
    }
    maybeShowInstallTip();

    // Pull vanaf KV bij opstarten (best-effort), daarna migreren indien nodig
    (async () => {
      try{
        const remoteFavs = await syncLoad(FKEY);
        if (remoteFavs) localStorage.setItem(FKEY, remoteFavs);
      }catch{}
      try{
        const remoteDeck = await syncLoad(SRS_KEY);
        if (remoteDeck) localStorage.setItem(SRS_KEY, remoteDeck);
      }catch{}
      try{ await LL_SRS.migrate(); }catch{}
    })();

    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js').catch(()=>{}); }
  
    // === Favorieten & Kaarten viewer ===
    (function(){
      const listBg = document.getElementById('listBg');
      const listSheet = document.getElementById('listSheet');
      const listTitle = document.getElementById('listTitle');
      const listContent = document.getElementById('listContent');
      const statusEl = document.getElementById('status');
      function openSheet(title, html){
        listTitle.textContent = title;
        listContent.innerHTML = html || '<div class="small">Niets om te tonen.</div>';
        listBg.style.display = 'block';
        listSheet.style.display = 'block';
        listSheet.focus();
      }
      function closeSheet(){
        listBg.style.display = 'none';
        listSheet.style.display = 'none';
      }
      document.getElementById('listClose').addEventListener('click', closeSheet);
      listBg.addEventListener('click', closeSheet);
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeSheet(); });

      function fmtDate(ts){
        try{ const d = new Date(ts); return d.toLocaleString(); }catch{ return ''; }
      }
      function esc(s){ return (s||'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m])); }

      function renderFavs(){
        const favs = getFavs();
        if (!favs.length) { openSheet('Favorieten', '<div class="small">Nog geen favorieten.</div>'); return; }
        const rows = favs.map((f,i)=>{
          const lang = (f.src||'') + ' ‚Üí ' + (f.dst||'');
          return \`
            <div class="pair" style="border:var(--hair);border-radius:12px;padding:10px;margin:6px 0;background:var(--panel-strong)">
              <div class="small">\${fmtDate(f.ts)} ¬∑ \${esc(lang)}</div>
              <div class="mono" style="margin-top:6px"><strong>NL:</strong> \${esc(f.input||f.inp||'')}</div>
              <div class="mono" style="margin-top:4px"><strong>‚Üí:</strong> \${esc(f.out||'')}</div>
              <div class="row" style="margin-top:6px">
                <button class="btn small" data-act="copy" data-idx="\${i}">Kopieer</button>
                <button class="btn small" data-act="toSrs" data-idx="\${i}">Voeg toe aan SRS</button>
                <button class="btn small" data-act="delFav" data-idx="\${i}">Verwijder</button>
              </div>
            </div>\`;
        }).join('');
        openSheet('Favorieten', rows);
        // event delegation
        listContent.querySelectorAll('button[data-act]').forEach(btn=>{
          btn.addEventListener('click', async (e)=>{
            const act = btn.dataset.act; const idx = +btn.dataset.idx;
            const favs2 = getFavs();
            const f = favs2[idx];
            if (!f) return;
            if (act==='copy'){
              try{ await navigator.clipboard.writeText(f.out||''); statusEl.textContent = 'Gekopieerd.'; }catch{}
            } else if (act==='toSrs'){
              const res = await LL_SRS.add(f.input||f.inp||'', f.out||'', f.src||'auto', f.dst||'pt', ['from:fav']);
              if (res.ok){
                statusEl.textContent = 'Aan SRS toegevoegd.';
                setSrsDeck(getSrsDeck()); // trigger sync
              } else {
                statusEl.textContent = 'Bestond al in SRS.';
              }
            } else if (act==='delFav'){
              favs2.splice(idx,1); setFavs(favs2);
              renderFavs();
            }
          });
        });
      }

      
      async function renderCards(){
        let deck = [];
        try{
          if (window.LL_SRS && typeof LL_SRS.listAll === 'function'){
            deck = await LL_SRS.listAll();
          } else {
            deck = getSrsDeck();
          }
        }catch{ deck = []; }
        if (!Array.isArray(deck) || deck.length===0){
          openSheet('Kaarten', '<div class="small">Nog geen kaarten. Voeg via ‚Äúüìö Oefenen‚Äù toe.</div>');
          return;
        }
        const rows = deck.map((c,i)=>{
          const due = c.due ? fmtDate(c.due) : '';
          const tags = Array.isArray(c.tags) && c.tags.length ? (' ¬∑ ' + c.tags.join(',')) : '';
          return `
            <div class="pair" style="border:var(--hair);border-radius:12px;padding:10px;margin:6px 0;background:var(--panel-strong)">
              <div class="small">${due ? ('Verval: '+due+' ¬∑ ') : ''}${esc((c.src||'')+' ‚Üí '+(c.dst||''))}${tags}</div>
              <div class="mono" style="margin-top:6px"><strong>Voor:</strong> ${esc(c.front||'')}</div>
              <div class="mono" style="margin-top:4px"><strong>Achter:</strong> ${esc(c.back||'')}</div>
              <div class="row" style="margin-top:6px">
                <button class="btn small" data-act="copyBack" data-id="${esc(c.id||'')}">Kopieer</button>
                <button class="btn small" data-act="delCard" data-id="${esc(c.id||'')}" data-idx="${i}">Verwijder</button>
              </div>
            </div>`;
        }).join('');
        openSheet('Kaarten', rows);

        listContent.querySelectorAll('button[data-act]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const act = btn.dataset.act;
            const id = btn.dataset.id;
            if (act==='copyBack'){
              try{
                const card = (deck.find(d=>d.id===id) || {});
                await navigator.clipboard.writeText(card.back||''); statusEl.textContent = 'Gekopieerd.';
              }catch{}
            } else if (act==='delCard'){
              try{ await LL_SRS.remove(id); }catch{}
              try{
                const idx = +btn.dataset.idx;
                if (!Number.isNaN(idx)) { deck.splice(idx,1); setSrsDeck(deck); }
              }catch{}
              renderCards();
            }
          });
        });
      }

      const btnFavs = document.getElementById('btnViewFavs');
      const btnCards = document.getElementById('btnViewCards');
      if (btnFavs) btnFavs.addEventListener('click', renderFavs);
      if (btnCards) btnCards.addEventListener('click', renderCards);
    })();
</script>
</body>
</html>
