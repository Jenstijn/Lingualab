<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>LinguaLab ‚Äî Vandaag</title>
  <meta name="theme-color" content="#0b1021">
  <link rel="stylesheet" href="./ll-brazil-ipad-v2.css">
  <style>
    *,*::before,*::after{box-sizing:border-box}
    :root{--bg:#0c0e10;--panel:rgba(255,255,255,.08);--panel2:rgba(255,255,255,.12);--text:#e8ecf1;--muted:#a8b0ba;--hair:1px solid rgba(255,255,255,.14)}
    @media (prefers-color-scheme:light){:root{--bg:#f6f7fb;--panel:rgba(255,255,255,.65);--panel2:rgba(255,255,255,.8);--text:#0b1520;--muted:#536070;--hair:1px solid rgba(0,0,0,.08)}}
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(18px) saturate(130%);background:linear-gradient(180deg,rgba(0,0,0,.25),rgba(0,0,0,.05));border-bottom:var(--hair);padding-top:env(safe-area-inset-top)}
    .wrap{max-width:920px;margin:0 auto;padding:16px}
    h1,h2,h3{margin:0 0 6px 0}
    .panel{background:var(--panel);border:var(--hair);border-radius:16px;padding:14px;backdrop-filter:blur(18px) saturate(130%);box-shadow:0 10px 30px rgba(0,0,0,.25);margin-top:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{border:var(--hair);border-radius:12px;padding:10px 12px;background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.06));min-height:42px;color:var(--text);cursor:pointer;text-decoration:none}
    .small{font-size:12px;color:var(--muted)}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .pill{display:inline-flex;align-items:center;border:var(--hair);background:var(--panel2);padding:4px 10px;border-radius:999px;margin:2px}
    #bulk{width:100%;min-height:120px;border:var(--hair);border-radius:12px;background:var(--panel2);color:var(--text);padding:10px}
  </style>
</head>
<body>
<div id="ll-header"></div>
<script src="./ll-nav.js" defer></script>

<main class="wrap">
  <section class="panel">
    <h3>1) Reviews</h3>
    <div class="row">
      <div><span id="due" class="pill">‚è∞ 0 due</span> <span id="total" class="pill">üìö 0 kaarten</span></div>
      <button class="btn" id="startDue">Start reviews</button>
      <button class="btn" id="btnSync">‚ü≥ Sync & herlaad</button>
      <span id="syncStatus" class="small"></span>
    </div>
      <div class="row small" id="syncUI" style="gap:8px;margin-top:8px;flex-wrap:wrap">
        <label>Sync-code: <input id="syncCode" class="btn" style="min-width:240px" placeholder="plak code hier"></label>
        <button class="btn" id="btnCopyCode" title="Kopieer jouw code">Kopieer code</button>
        <button class="btn" id="btnSetCode" title="Gebruik deze code op dit device">Zet code</button>
        <button class="btn" id="btnSyncNow" title="Push & pull">Nu synchroniseren</button>
        <span id="syncHint" class="small"></span>
      </div>
    
  </section>

  <section class="panel">
    <h3>2) Nieuwe woorden</h3>
    <div class="row">
      <label class="small">Dagdoel:
        <select id="goal"><option>5</option><option selected>10</option><option>20</option></select>
      </label>
      <button class="btn" id="suggest">Suggereren uit favorieten</button>
      <button class="btn" id="addN">Voeg N toe</button>
    </div>
    <div id="suggestList" class="small" style="margin-top:8px"></div>
    <div class="row" style="margin-top:8px; width:100%">
      <textarea id="bulk" placeholder="Plak hier nieuwe items (√©√©n per regel) ‚Äî NL;PT of alleen NL"></textarea>
    </div>
  </section>

  <section class="panel">
    <h3>3) Luister / Shadow</h3>
    <div class="row">
      <button class="btn" id="play">‚ñ∂Ô∏é Speel voorbeeld</button>
      <button class="btn" id="rec">‚è∫ Neem op</button>
      <button class="btn" id="stop" disabled>‚èπ Stop</button>
      <span id="score" class="small"></span>
    </div>
    <div id="phrase" class="mono" style="margin-top:8px"></div>
  </section>

  <section class="panel">
    <div class="row">
      <a class="btn" href="train.html">Open oefenmodus</a>
      <a class="btn" href="progress.html">Voortgang</a>
      <a class="btn" href="index.html">Terug naar vertalen</a>
    </div>
  </section>
</main>

<script src="./srs2.js"></script>
<script>
/* === SYNC (Cloudflare KV) === */
const SYNC_BASE = 'https://lingualab-sync.8p8kxkrcnj.workers.dev';
const FKEY = 'll_favs_v1';
const SRS_KEY = (() => {
  for (let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if (/^ll_srs_/i.test(k)) return k;
  }
  return 'll_srs_v1';
})();
function getUID(){
  let id = localStorage.getItem('ll_uid');
  if (!id) { id = 'u_' + Math.random().toString(36).slice(2) + Date.now().toString(36); localStorage.setItem('ll_uid', id); }
  return id;
}
async function syncSave(key, value){
  try{
    const payload = typeof value === 'string' ? value : JSON.stringify(value);
    await fetch(`${SYNC_BASE}/save`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ uid:getUID(), key, value:payload }) });
    return true;
  }catch{ return false; }
}
async function syncLoad(key){
  try{
    const res = await fetch(`${SYNC_BASE}/get?uid=${encodeURIComponent(getUID())}&key=${encodeURIComponent(key)}`);
    if (!res.ok) return null;
    const j = await res.json();
    return j?.value ?? null;
  }catch{ return null; }
}
async function pullFromKV(){
  const favs = await syncLoad(FKEY);
  if (favs) { try { const arr = JSON.parse(favs); if (Array.isArray(arr)) localStorage.setItem(FKEY, favs); } catch {} }
  const deck = await syncLoad(SRS_KEY);
  if (deck) { try { const arr = JSON.parse(deck); if (Array.isArray(arr)) localStorage.setItem(SRS_KEY, deck); } catch {} }
}
async function pushDeckToKV(){
  try{
    if (window.LL_SRS?.export) {
      const deck = await LL_SRS.export();
      await syncSave(SRS_KEY, deck);
    } else {
      const raw = localStorage.getItem(SRS_KEY) || '[]';
      await syncSave(SRS_KEY, raw);
    }
  }catch{}
}

/* === UI/LOGICA === */
const $ = (id) => document.getElementById(id);

async function refreshCounts(){
  const dueArr = await LL_SRS.due(10000);
  const total = await LL_SRS.count();
  $('due').textContent = `‚è∞ ${dueArr.length} due`;
  $('total').textContent = `üìö ${total} kaarten`;
}
$('startDue').addEventListener('click', ()=>{ window.location.href = 'train.html?mode=due'; });

function getFavs(){ try{return JSON.parse(localStorage.getItem(FKEY))||[];}catch{return [];} }
let suggestions = [];

$('suggest').addEventListener('click', ()=>{
  const favs = getFavs();
  const existing = new Set();
  const listEl = $('suggestList');
  listEl.textContent = '';
  suggestions = [];
  favs.slice(0,200).forEach(f=>{
    const front = f.input||''; const back = f.out||''; if(!front || !back) return;
    const id = ('id_'+btoa(unescape(encodeURIComponent(front.slice(0,120)+(f.src||'auto')+(f.dst||'pt'))))).replace(/=+$/,'');
    if (existing.has(id)) return; existing.add(id);
    suggestions.push({front,back,src:f.src||'auto',dst:f.dst||'pt',tags:['fav']});
  });
  if (!suggestions.length){ listEl.textContent = 'Geen favorieten gevonden (of alles al in deck).'; return; }
  listEl.innerHTML = suggestions.slice(0,30).map(s=>`<span class="pill">‚≠ê ${s.front}</span>`).join(' ');
});

$('addN').addEventListener('click', async ()=>{
  const N = parseInt($('goal').value,10) || 10;
  let added = 0;

  for (const s of suggestions.slice(0,N)){
    const r = await LL_SRS.add(s.front, s.back, s.src, s.dst, s.tags);
    if (r.ok) added++;
  }

  const bulk = $('bulk').value.trim();
  if (bulk){
    const lines = bulk.split(/\r?\n/);
    for (const line of lines){
      const m = line.split(';');
      const front = m[0]?.trim(); const back = (m[1]||'').trim();
      if (!front) continue;
      const r = await LL_SRS.add(front, back || '(vertalen tijdens oefenen)', 'nl', 'pt', ['bulk']);
      if (r.ok) added++;
    }
  }

  await pushDeckToKV();

  alert('Toegevoegd: '+added);
  $('bulk').value=''; suggestions=[]; $('suggestList').textContent='';
  refreshCounts();
});

// Luister / shadow
const phrases = [
  'Eu vou trabalhar amanh√£.',
  'Ela estava estudando quando cheguei.',
  'N√≥s temos falado com ele.',
  'Eles v√£o viajar no fim de semana.',
  'Voc√™ j√° comeu hoje?',
  'Eu tenho pensado nisso.',
  'A gente estava esperando voc√™.',
  'Quando eu chegar, te ligo.'
];
let current = phrases[Math.floor(Math.random()*phrases.length)];
$('phrase').textContent = current;

function speak(s){ try{ const u=new SpeechSynthesisUtterance(s); u.lang='pt-BR'; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch{} }
$('play').addEventListener('click', ()=> speak(current));

let media, chunks=[];
$('rec').addEventListener('click', async ()=>{
  try{
    media = await navigator.mediaDevices.getUserMedia({audio:true});
    const rec = new MediaRecorder(media);
    chunks=[];
    const start = performance.now();
    rec.ondataavailable = e=> chunks.push(e.data);
    rec.onstop = ()=>{
      const durSpeak = (performance.now()-start)/1000;
      const target = Math.max(2.0, current.length/6);
      const diff = Math.abs(durSpeak-target);
      const score = Math.max(0, Math.round(100 - (diff*100/target)));
      $('score').textContent = `‚è± ritme-score: ${score}/100 (doel ~${target.toFixed(1)}s, jij ${durSpeak.toFixed(1)}s)`;
      media.getTracks().forEach(t=>t.stop());
    };
    rec.start();
    $('stop').disabled=false;
    $('stop').onclick = ()=>{ rec.stop(); $('stop').disabled=true; };
  }catch{ alert('Geen microfoon-toegang.'); }
});

// Handmatige sync-knop
$('btnSync').addEventListener('click', async ()=>{
  $('syncStatus').textContent = 'Syncen‚Ä¶';
  await pullFromKV();
  await LL_SRS.migrate().catch(()=>{});
  await refreshCounts();
  $('syncStatus').textContent = 'Bijgewerkt.';
});

// INIT
(async () => {
  await pullFromKV();
  await LL_SRS.migrate().catch(()=>{});
  await refreshCounts();
})();


// === Sync helpers (deck + favs) ===
function setUID(newId){
  newId = (newId||'').trim();
  if (!/^[A-Za-z0-9_-]{6,60}$/.test(newId)) { alert('Ongeldige code. Gebruik alleen letters/cijfers/_- (min 6).'); return false; }
  localStorage.setItem('ll_uid', newId);
  return true;
}
function getFavsLocal(){ try { return JSON.parse(localStorage.getItem(FKEY) || '[]'); } catch { return []; } }
function setFavsLocal(f){ try { localStorage.setItem(FKEY, JSON.stringify(f||[])); } catch{} }
async function pushFavsToKV(){
  try{ const data = localStorage.getItem(FKEY) || '[]'; await syncSave(FKEY, data); }catch{}
}
async function pullFavsFromKVAndMerge(){
  try{
    const remote = await syncLoad(FKEY);
    if (!remote) return;
    const r = JSON.parse(remote||'[]'); if (!Array.isArray(r)) return;
    const l = getFavsLocal(); const map = new Map();
    function keyOf(x){ return (x.input||x.inp||'')+'|'+(x.out||'')+'|'+(x.src||'')+'>'+ (x.dst||''); }
    [...l, ...r].forEach(it=>{
      const k = keyOf(it); const old = map.get(k);
      if (!old || (it.ts||0) > (old.ts||0)) map.set(k, it);
    });
    const merged = Array.from(map.values()).sort((a,b)=>(b.ts||0)-(a.ts||0)).slice(0,200);
    setFavsLocal(merged);
  }catch{}
}
async function pushDeckToKV_All(){
  try{
    if (window.LL_SRS && typeof LL_SRS.listAll==='function'){
      const deck = await LL_SRS.listAll();
      await syncSave(SRS_KEY, JSON.stringify(deck||[]));
    } else {
      const raw = localStorage.getItem(SRS_KEY) || '[]';
      await syncSave(SRS_KEY, raw);
    }
  }catch{}
}
async function pullDeckFromKV_Replace(){
  try{
    const deckStr = await syncLoad(SRS_KEY);
    if (!deckStr) return;
    const deck = JSON.parse(deckStr||'[]'); if (!Array.isArray(deck)) return;
    // Replace local IndexedDB with cloud deck
    try{ indexedDB.deleteDatabase('lingualab'); }catch{}
    try{
      // Recreate via LL_SRS.add/update
      if (window.LL_SRS){
        for (const c of deck){
          // If card has full fields, write directly via update; else reconstruct via add
          if (c && c.id && typeof LL_SRS.update==='function') await LL_SRS.update(c);
        }
      }
    }catch{}
    // Mirror to localStorage too
    try{ localStorage.setItem(SRS_KEY, JSON.stringify(deck||[])); }catch{}
  }catch{}
}
async function syncNowFull(){
  // push local first, then merge/pull from cloud
  await pushFavsToKV();
  await pushDeckToKV_All();
  await pullFavsFromKVAndMerge();
  await pullDeckFromKV_Replace();
  try{ document.getElementById('syncStatus').textContent = 'Gesynchroniseerd.'; }catch{}
}
(function initSyncUI(){
  try{
    const codeEl = document.getElementById('syncCode');
    const hint = document.getElementById('syncHint');
    const uid = getUID();
    if (codeEl) codeEl.placeholder = uid;
    if (hint) hint.textContent = 'Gebruik dezelfde code op je andere devices.';
    const btnCopy = document.getElementById('btnCopyCode');
    btnCopy?.addEventListener('click', ()=>{ try{ navigator.clipboard.writeText(getUID()); alert('Code gekopieerd.'); }catch{} });
    const btnSet = document.getElementById('btnSetCode');
    btnSet?.addEventListener('click', async ()=>{
      const val = (codeEl?.value||'').trim(); if (!val){ alert('Plak eerst je code.'); return; }
      if (!setUID(val)) return;
      await syncNowFull();
      alert('Sync-code ingesteld en gegevens gesynchroniseerd.');
    });
    const btnNow = document.getElementById('btnSyncNow');
    const btnLegacy = document.getElementById('btnSync');
    btnNow?.addEventListener('click', syncNowFull);
    btnLegacy?.addEventListener('click', syncNowFull);
    // Also auto-pull when tab becomes visible
    document.addEventListener('visibilitychange', ()=>{ if (!document.hidden) syncNowFull(); });
    // And periodic light sync (every 45s)
    setInterval(syncNowFull, 45000);
  }catch(e){}
})();
</script>
</body>
</html>
